
Action: {"tool_name": "mcp_bulk_file_writer", "tool_arguments": {"files": [{"path": "/app/backend/server.py", "content": "from fastapi import FastAPI, APIRouter, HTTPException, UploadFile, File, Form\nfrom fastapi.responses import StreamingResponse\nfrom dotenv import load_dotenv\nfrom starlette.middleware.cors import CORSMiddleware\nfrom motor.motor_asyncio import AsyncIOMotorClient\nimport os\nimport logging\nfrom pathlib import Path\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom typing import List, Optional\nimport uuid\nfrom datetime import datetime, timezone\nimport base64\nimport asyncio\n\nROOT_DIR = Path(__file__).parent\nload_dotenv(ROOT_DIR / '.env')\n\n# MongoDB connection\nmongo_url = os.environ['MONGO_URL']\nclient = AsyncIOMotorClient(mongo_url)\ndb = client[os.environ['DB_NAME']]\n\n# Create the main app without a prefix\napp = FastAPI()\n\n# Create a router with the /api prefix\napi_router = APIRouter(prefix=\"/api\")\n\n# Models\nclass Vehicle(BaseModel):\n    model_config = ConfigDict(extra=\"ignore\")\n    id: str = Field(default_factory=lambda: str(uuid.uuid4()))\n    vin: str\n    make: str = \"Ford\"\n    model: str\n    year: int\n    ecm_type: str\n    last_connected: Optional[str] = None\n    calibration_id: Optional[str] = None\n    software_version: Optional[str] = None\n    created_at: str = Field(default_factory=lambda: datetime.now(timezone.utc).isoformat())\n\nclass VehicleCreate(BaseModel):\n    vin: str\n    model: str\n    year: int\n    ecm_type: str\n\nclass Firmware(BaseModel):\n    model_config = ConfigDict(extra=\"ignore\")\n    id: str = Field(default_factory=lambda: str(uuid.uuid4()))\n    name: str\n    version: str\n    file_size: int\n    file_data: str  # Base64 encoded\n    compatible_models: List[str]\n    compatible_years: List[int]\n    checksum: str\n    uploaded_at: str = Field(default_factory=lambda: datetime.now(timezone.utc).isoformat())\n\nclass FlashSession(BaseModel):\n    model_config = ConfigDict(extra=\"ignore\")\n    id: str = Field(default_factory=lambda: str(uuid.uuid4()))\n    vehicle_id: str\n    firmware_id: str\n    status: str  # pending, in_progress, completed, failed, cancelled\n    progress: int = 0\n    started_at: str = Field(default_factory=lambda: datetime.now(timezone.utc).isoformat())\n    completed_at: Optional[str] = None\n    error_message: Optional[str] = None\n    backup_id: Optional[str] = None\n\nclass FlashSessionCreate(BaseModel):\n    vehicle_id: str\n    firmware_id: str\n\nclass BridgeService(BaseModel):\n    model_config = ConfigDict(extra=\"ignore\")\n    id: str = Field(default_factory=lambda: str(uuid.uuid4()))\n    name: str\n    host: str\n    port: int\n    status: str  # online, offline\n    adapter_type: str  # J2534, ELM327, etc\n    last_heartbeat: str = Field(default_factory=lambda: datetime.now(timezone.utc).isoformat())\n\nclass BridgeServiceRegister(BaseModel):\n    name: str\n    host: str\n    port: int\n    adapter_type: str\n\nclass ECMData(BaseModel):\n    vin: str\n    calibration_id: str\n    software_version: str\n    hardware_version: str\n    dtc_codes: List[str]\n    battery_voltage: float\n\nclass BackupData(BaseModel):\n    model_config = ConfigDict(extra=\"ignore\")\n    id: str = Field(default_factory=lambda: str(uuid.uuid4()))\n    vehicle_id: str\n    backup_data: str  # Base64 encoded\n    size: int\n    created_at: str = Field(default_factory=lambda: datetime.now(timezone.utc).isoformat())\n    description: str\n\n# Routes\n@api_router.get(\"/\")\nasync def root():\n    return {\"message\": \"Ford ECM Flash Tool API\", \"version\": \"1.0.0\"}\n\n# Vehicle Management\n@api_router.post(\"/vehicles\", response_model=Vehicle)\nasync def create_vehicle(vehicle: VehicleCreate):\n    vehicle_obj = Vehicle(**vehicle.model_dump())\n    doc = vehicle_obj.model_dump()\n    await db.vehicles.insert_one(doc)\n    return vehicle_obj\n\n@api_router.get(\"/vehicles\", response_model=List[Vehicle])\nasync def get_vehicles():\n    vehicles = await db.vehicles.find({}, {\"_id\": 0}).to_list(1000)\n    return vehicles\n\n@api_router.get(\"/vehicles/{vehicle_id}\", response_model=Vehicle)\nasync def get_vehicle(vehicle_id: str):\n    vehicle = await db.vehicles.find_one({\"id\": vehicle_id}, {\"_id\": 0})\n    if not vehicle:\n        raise HTTPException(status_code=404, detail=\"Vehicle not found\")\n    return vehicle\n\n@api_router.delete(\"/vehicles/{vehicle_id}\")\nasync def delete_vehicle(vehicle_id: str):\n    result = await db.vehicles.delete_one({\"id\": vehicle_id})\n    if result.deleted_count == 0:\n        raise HTTPException(status_code=404, detail=\"Vehicle not found\")\n    return {\"message\": \"Vehicle deleted successfully\"}\n\n# Firmware Management\n@api_router.post(\"/firmware\")\nasync def upload_firmware(\n    name: str = Form(...),\n    version: str = Form(...),\n    compatible_models: str = Form(...),\n    compatible_years: str = Form(...),\n    file: UploadFile = File(...)\n):\n    file_content = await file.read()\n    file_data_b64 = base64.b64encode(file_content).decode('utf-8')\n    \n    # Simple checksum\n    checksum = str(hash(file_content))[-16:]\n    \n    firmware_obj = Firmware(\n        name=name,\n        version=version,\n        file_size=len(file_content),\n        file_data=file_data_b64,\n        compatible_models=compatible_models.split(','),\n        compatible_years=[int(y) for y in compatible_years.split(',')],\n        checksum=checksum\n    )\n    \n    doc = firmware_obj.model_dump()\n    await db.firmware.insert_one(doc)\n    \n    # Return without file_data for response\n    response = firmware_obj.model_dump()\n    response.pop('file_data', None)\n    return response\n\n@api_router.get(\"/firmware\")\nasync def get_firmware():\n    firmware_list = await db.firmware.find({}, {\"_id\": 0, \"file_data\": 0}).to_list(1000)\n    return firmware_list\n\n@api_router.get(\"/firmware/{firmware_id}\")\nasync def get_firmware_details(firmware_id: str, include_data: bool = False):\n    projection = {\"_id\": 0}\n    if not include_data:\n        projection[\"file_data\"] = 0\n    \n    firmware = await db.firmware.find_one({\"id\": firmware_id}, projection)\n    if not firmware:\n        raise HTTPException(status_code=404, detail=\"Firmware not found\")\n    return firmware\n\n@api_router.delete(\"/firmware/{firmware_id}\")\nasync def delete_firmware(firmware_id: str):\n    result = await db.firmware.delete_one({\"id\": firmware_id})\n    if result.deleted_count == 0:\n        raise HTTPException(status_code=404, detail=\"Firmware not found\")\n    return {\"message\": \"Firmware deleted successfully\"}\n\n# Flash Session Management\n@api_router.post(\"/flash-sessions\", response_model=FlashSession)\nasync def create_flash_session(session: FlashSessionCreate):\n    # Validate vehicle exists\n    vehicle = await db.vehicles.find_one({\"id\": session.vehicle_id})\n    if not vehicle:\n        raise HTTPException(status_code=404, detail=\"Vehicle not found\")\n    \n    # Validate firmware exists\n    firmware = await db.firmware.find_one({\"id\": session.firmware_id})\n    if not firmware:\n        raise HTTPException(status_code=404, detail=\"Firmware not found\")\n    \n    session_obj = FlashSession(**session.model_dump(), status=\"pending\")\n    doc = session_obj.model_dump()\n    await db.flash_sessions.insert_one(doc)\n    return session_obj\n\n@api_router.get(\"/flash-sessions\", response_model=List[FlashSession])\nasync def get_flash_sessions():\n    sessions = await db.flash_sessions.find({}, {\"_id\": 0}).sort(\"started_at\", -1).to_list(1000)\n    return sessions\n\n@api_router.get(\"/flash-sessions/{session_id}\", response_model=FlashSession)\nasync def get_flash_session(session_id: str):\n    session = await db.flash_sessions.find_one({\"id\": session_id}, {\"_id\": 0})\n    if not session:\n        raise HTTPException(status_code=404, detail=\"Flash session not found\")\n    return session\n\n@api_router.patch(\"/flash-sessions/{session_id}\")\nasync def update_flash_session(session_id: str, status: str, progress: int = 0, error_message: Optional[str] = None):\n    update_data = {\"status\": status, \"progress\": progress}\n    \n    if status in [\"completed\", \"failed\", \"cancelled\"]:\n        update_data[\"completed_at\"] = datetime.now(timezone.utc).isoformat()\n    \n    if error_message:\n        update_data[\"error_message\"] = error_message\n    \n    result = await db.flash_sessions.update_one(\n        {\"id\": session_id},\n        {\"$set\": update_data}\n    )\n    \n    if result.matched_count == 0:\n        raise HTTPException(status_code=404, detail=\"Flash session not found\")\n    \n    return {\"message\": \"Flash session updated\"}\n\n# Bridge Service Management\n@api_router.post(\"/bridge-services\", response_model=BridgeService)\nasync def register_bridge_service(service: BridgeServiceRegister):\n    # Check if already exists\n    existing = await db.bridge_services.find_one({\"host\": service.host, \"port\": service.port})\n    \n    if existing:\n        # Update existing\n        await db.bridge_services.update_one(\n            {\"host\": service.host, \"port\": service.port},\n            {\"$set\": {\n                \"status\": \"online\",\n                \"last_heartbeat\": datetime.now(timezone.utc).isoformat(),\n                \"adapter_type\": service.adapter_type\n            }}\n        )\n        updated = await db.bridge_services.find_one({\"host\": service.host, \"port\": service.port}, {\"_id\": 0})\n        return updated\n    \n    service_obj = BridgeService(**service.model_dump(), status=\"online\")\n    doc = service_obj.model_dump()\n    await db.bridge_services.insert_one(doc)\n    return service_obj\n\n@api_router.get(\"/bridge-services\", response_model=List[BridgeService])\nasync def get_bridge_services():\n    services = await db.bridge_services.find({}, {\"_id\": 0}).to_list(1000)\n    return services\n\n@api_router.post(\"/bridge-services/{service_id}/heartbeat\")\nasync def bridge_heartbeat(service_id: str):\n    result = await db.bridge_services.update_one(\n        {\"id\": service_id},\n        {\"$set\": {\n            \"status\": \"online\",\n            \"last_heartbeat\": datetime.now(timezone.utc).isoformat()\n        }}\n    )\n    if result.matched_count == 0:\n        raise HTTPException(status_code=404, detail=\"Bridge service not found\")\n    return {\"message\": \"Heartbeat recorded\"}\n\n# ECM Operations (simulated - real implementation via bridge service)\n@api_router.post(\"/ecm/read/{vehicle_id}\")\nasync def read_ecm_data(vehicle_id: str):\n    vehicle = await db.vehicles.find_one({\"id\": vehicle_id})\n    if not vehicle:\n        raise HTTPException(status_code=404, detail=\"Vehicle not found\")\n    \n    # Simulate ECM read\n    await asyncio.sleep(2)  # Simulate reading time\n    \n    ecm_data = ECMData(\n        vin=vehicle['vin'],\n        calibration_id=f\"CAL-{vehicle['year']}-{vehicle['model'][:3].upper()}\",\n        software_version=\"1.2.3\",\n        hardware_version=\"HW-2.1\",\n        dtc_codes=[\"P0171\", \"P0420\"] if hash(vehicle['vin']) % 2 == 0 else [],\n        battery_voltage=12.8\n    )\n    \n    # Update vehicle with ECM data\n    await db.vehicles.update_one(\n        {\"id\": vehicle_id},\n        {\"$set\": {\n            \"calibration_id\": ecm_data.calibration_id,\n            \"software_version\": ecm_data.software_version,\n            \"last_connected\": datetime.now(timezone.utc).isoformat()\n        }}\n    )\n    \n    return ecm_data\n\n# Backup Management\n@api_router.post(\"/backups\")\nasync def create_backup(vehicle_id: str, description: str):\n    vehicle = await db.vehicles.find_one({\"id\": vehicle_id})\n    if not vehicle:\n        raise HTTPException(status_code=404, detail=\"Vehicle not found\")\n    \n    # Simulate backup creation\n    backup_data = f\"BACKUP_DATA_{vehicle_id}_{datetime.now().timestamp()}\"\n    backup_data_b64 = base64.b64encode(backup_data.encode()).decode('utf-8')\n    \n    backup_obj = BackupData(\n        vehicle_id=vehicle_id,\n        backup_data=backup_data_b64,\n        size=len(backup_data),\n        description=description\n    )\n    \n    doc = backup_obj.model_dump()\n    await db.backups.insert_one(doc)\n    \n    response = backup_obj.model_dump()\n    response.pop('backup_data', None)\n    return response\n\n@api_router.get(\"/backups\")\nasync def get_backups(vehicle_id: Optional[str] = None):\n    query = {}\n    if vehicle_id:\n        query[\"vehicle_id\"] = vehicle_id\n    \n    backups = await db.backups.find(query, {\"_id\": 0, \"backup_data\": 0}).sort(\"created_at\", -1).to_list(1000)\n    return backups\n\n@api_router.post(\"/backups/{backup_id}/restore\")\nasync def restore_backup(backup_id: str):\n    backup = await db.backups.find_one({\"id\": backup_id})\n    if not backup:\n        raise HTTPException(status_code=404, detail=\"Backup not found\")\n    \n    # Simulate restore\n    await asyncio.sleep(3)\n    \n    return {\"message\": \"Backup restored successfully\", \"backup_id\": backup_id}\n\n# Include the router in the main app\napp.include_router(api_router)\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_credentials=True,\n    allow_origins=os.environ.get('CORS_ORIGINS', '*').split(','),\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\n@app.on_event(\"shutdown\")\nasync def shutdown_db_client():\n    client.close()"}, {"path": "/app/backend/bridge_service.py", "content": "#!/usr/bin/env python3\n\"\"\"\nLocal Bridge Service for ECM Programming\n\nThis service runs on the user's local machine and communicates with\nOBD-II/J2534 hardware adapters for real ECM programming.\n\nRequirements:\n- J2534 compatible adapter (PassThru device)\n- Appropriate drivers installed\n- Python 3.8+\n\"\"\"\n\nimport asyncio\nimport json\nimport logging\nfrom datetime import datetime\nfrom typing import Optional, Dict, Any\nfrom fastapi import FastAPI, HTTPException\nfrom pydantic import BaseModel\nimport uvicorn\nimport requests\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\napp = FastAPI(title=\"ECM Bridge Service\")\n\n# Configuration\nWEB_BACKEND_URL = \"http://localhost:8001/api\"  # Update with actual backend URL\nBRIDGE_PORT = 8002\nADAPTER_TYPE = \"J2534\"  # or ELM327, etc.\n\nclass ConnectionRequest(BaseModel):\n    protocol: str = \"ISO15765\"\n    baudrate: int = 500000\n\nclass ECMReadRequest(BaseModel):\n    vin: str\n    read_dtc: bool = True\n\nclass FlashRequest(BaseModel):\n    firmware_data: str  # Base64 encoded\n    verify: bool = True\n\nclass HardwareAdapter:\n    \"\"\"Interface to J2534/OBD-II hardware adapter\"\"\"\n    \n    def __init__(self):\n        self.connected = False\n        self.device_id = None\n        self.channel_id = None\n        \n    async def detect_adapters(self):\n        \"\"\"Detect available J2534 adapters\"\"\"\n        logger.info(\"Detecting J2534 adapters...\")\n        \n        # In real implementation, use J2534 DLL/SO to detect devices\n        # Example: ctypes to load PassThruOpen, PassThruConnect\n        \n        # Simulated detection\n        adapters = [\n            {\"name\": \"Drew Technologies Mongoose\", \"id\": \"DT_MONGOOSE_001\"},\n            {\"name\": \"Tactrix OpenPort 2.0\", \"id\": \"TACTRIX_OP2_001\"}\n        ]\n        \n        logger.info(f\"Found {len(adapters)} adapter(s)\")\n        return adapters\n    \n    async def connect(self, protocol: str = \"ISO15765\", baudrate: int = 500000):\n        \"\"\"Connect to vehicle via adapter\"\"\"\n        logger.info(f\"Connecting with protocol: {protocol}, baudrate: {baudrate}\")\n        \n        # Real implementation would:\n        # 1. Call PassThruOpen() to open device\n        # 2. Call PassThruConnect() to establish channel\n        # 3. Set up filters and parameters\n        \n        await asyncio.sleep(1)  # Simulate connection time\n        \n        self.connected = True\n        self.device_id = \"DEV_001\"\n        self.channel_id = \"CHANNEL_001\"\n        \n        logger.info(\"Connected successfully\")\n        return {\"status\": \"connected\", \"device_id\": self.device_id}\n    \n    async def disconnect(self):\n        \"\"\"Disconnect from vehicle\"\"\"\n        if self.connected:\n            # Real: PassThruDisconnect(), PassThruClose()\n            await asyncio.sleep(0.5)\n            self.connected = False\n            logger.info(\"Disconnected\")\n        return {\"status\": \"disconnected\"}\n    \n    async def read_vin(self) -> str:\n        \"\"\"Read VIN from vehicle\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        # Real: Send UDS request 0x09 0x02 to read VIN\n        # Example: PassThruWriteMsgs() and PassThruReadMsgs()\n        \n        await asyncio.sleep(1)\n        \n        # Simulated VIN\n        vin = \"1FAHP3K29CL123456\"\n        logger.info(f\"Read VIN: {vin}\")\n        return vin\n    \n    async def read_calibration_id(self) -> str:\n        \"\"\"Read calibration ID\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        await asyncio.sleep(0.5)\n        return \"CAL-2023-FORD-MUSTANG\"\n    \n    async def read_software_version(self) -> str:\n        \"\"\"Read software version\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        await asyncio.sleep(0.5)\n        return \"SW-1.2.3.456\"\n    \n    async def read_dtc_codes(self) -> list:\n        \"\"\"Read diagnostic trouble codes\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        # Real: Send 0x03 request to read stored DTCs\n        await asyncio.sleep(1)\n        \n        # Simulated DTCs\n        return [\"P0171\", \"P0420\"]\n    \n    async def clear_dtc_codes(self):\n        \"\"\"Clear diagnostic trouble codes\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        # Real: Send 0x04 request to clear DTCs\n        await asyncio.sleep(1)\n        logger.info(\"DTCs cleared\")\n        return {\"status\": \"cleared\"}\n    \n    async def check_battery_voltage(self) -> float:\n        \"\"\"Check battery voltage\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        # Real: Read voltage via OBD PIDs\n        await asyncio.sleep(0.3)\n        return 12.8\n    \n    async def enter_programming_mode(self):\n        \"\"\"Enter ECM programming mode\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        logger.info(\"Entering programming mode...\")\n        \n        # Real: Send security access requests, seed/key exchange\n        # UDS 0x27 for security access\n        # UDS 0x10 to enter programming session\n        \n        await asyncio.sleep(2)\n        logger.info(\"Entered programming mode\")\n        return {\"status\": \"programming_mode\"}\n    \n    async def flash_firmware(self, firmware_data: bytes, progress_callback=None):\n        \"\"\"Flash firmware to ECM\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        logger.info(f\"Starting firmware flash ({len(firmware_data)} bytes)...\")\n        \n        # Real implementation:\n        # 1. Erase flash memory (UDS 0x31)\n        # 2. Request download (UDS 0x34)\n        # 3. Transfer data (UDS 0x36) in blocks\n        # 4. Request transfer exit (UDS 0x37)\n        # 5. Checksum verification\n        \n        total_blocks = 100\n        for i in range(total_blocks):\n            await asyncio.sleep(0.1)  # Simulate flash time\n            progress = int((i + 1) / total_blocks * 100)\n            \n            if progress_callback:\n                await progress_callback(progress)\n            \n            if i % 20 == 0:\n                logger.info(f\"Flash progress: {progress}%\")\n        \n        logger.info(\"Firmware flash completed\")\n        return {\"status\": \"completed\", \"progress\": 100}\n    \n    async def verify_firmware(self) -> bool:\n        \"\"\"Verify flashed firmware\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        logger.info(\"Verifying firmware...\")\n        \n        # Real: Calculate and compare checksums\n        await asyncio.sleep(2)\n        \n        logger.info(\"Firmware verification successful\")\n        return True\n    \n    async def exit_programming_mode(self):\n        \"\"\"Exit programming mode and reset ECM\"\"\"\n        if not self.connected:\n            raise Exception(\"Not connected to vehicle\")\n        \n        logger.info(\"Exiting programming mode...\")\n        \n        # Real: Send ECU reset (UDS 0x11)\n        await asyncio.sleep(1)\n        \n        logger.info(\"Exited programming mode\")\n        return {\"status\": \"normal_mode\"}\n\n# Global adapter instance\nadapter = HardwareAdapter()\n\n# API Routes\n@app.get(\"/\")\nasync def root():\n    return {\n        \"service\": \"ECM Bridge Service\",\n        \"version\": \"1.0.0\",\n        \"adapter_type\": ADAPTER_TYPE,\n        \"status\": \"running\"\n    }\n\n@app.get(\"/adapters\")\nasync def list_adapters():\n    \"\"\"List available hardware adapters\"\"\"\n    adapters = await adapter.detect_adapters()\n    return {\"adapters\": adapters}\n\n@app.post(\"/connect\")\nasync def connect_vehicle(request: ConnectionRequest):\n    \"\"\"Connect to vehicle\"\"\"\n    try:\n        result = await adapter.connect(request.protocol, request.baudrate)\n        return result\n    except Exception as e:\n        logger.error(f\"Connection error: {e}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.post(\"/disconnect\")\nasync def disconnect_vehicle():\n    \"\"\"Disconnect from vehicle\"\"\"\n    result = await adapter.disconnect()\n    return result\n\n@app.get(\"/status\")\nasync def get_status():\n    \"\"\"Get connection status\"\"\"\n    return {\n        \"connected\": adapter.connected,\n        \"device_id\": adapter.device_id,\n        \"adapter_type\": ADAPTER_TYPE\n    }\n\n@app.post(\"/ecm/read\")\nasync def read_ecm(request: ECMReadRequest):\n    \"\"\"Read ECM data\"\"\"\n    try:\n        if not adapter.connected:\n            raise HTTPException(status_code=400, detail=\"Not connected to vehicle\")\n        \n        vin = await adapter.read_vin()\n        calibration_id = await adapter.read_calibration_id()\n        software_version = await adapter.read_software_version()\n        battery_voltage = await adapter.check_battery_voltage()\n        \n        dtc_codes = []\n        if request.read_dtc:\n            dtc_codes = await adapter.read_dtc_codes()\n        \n        return {\n            \"vin\": vin,\n            \"calibration_id\": calibration_id,\n            \"software_version\": software_version,\n            \"battery_voltage\": battery_voltage,\n            \"dtc_codes\": dtc_codes,\n            \"timestamp\": datetime.now().isoformat()\n        }\n    except Exception as e:\n        logger.error(f\"ECM read error: {e}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.post(\"/ecm/flash\")\nasync def flash_ecm(request: FlashRequest):\n    \"\"\"Flash firmware to ECM\"\"\"\n    try:\n        if not adapter.connected:\n            raise HTTPException(status_code=400, detail=\"Not connected to vehicle\")\n        \n        # Decode firmware data\n        import base64\n        firmware_data = base64.b64decode(request.firmware_data)\n        \n        # Check battery voltage\n        voltage = await adapter.check_battery_voltage()\n        if voltage < 12.0:\n            raise HTTPException(status_code=400, detail=f\"Battery voltage too low: {voltage}V (minimum 12.0V)\")\n        \n        # Enter programming mode\n        await adapter.enter_programming_mode()\n        \n        # Flash firmware\n        result = await adapter.flash_firmware(firmware_data)\n        \n        # Verify if requested\n        if request.verify:\n            verified = await adapter.verify_firmware()\n            result[\"verified\"] = verified\n        \n        # Exit programming mode\n        await adapter.exit_programming_mode()\n        \n        return result\n    except Exception as e:\n        logger.error(f\"Flash error: {e}\")\n        # Try to exit programming mode on error\n        try:\n            await adapter.exit_programming_mode()\n        except:\n            pass\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.post(\"/dtc/clear\")\nasync def clear_dtc():\n    \"\"\"Clear diagnostic trouble codes\"\"\"\n    try:\n        if not adapter.connected:\n            raise HTTPException(status_code=400, detail=\"Not connected to vehicle\")\n        \n        result = await adapter.clear_dtc_codes()\n        return result\n    except Exception as e:\n        logger.error(f\"Clear DTC error: {e}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\nasync def register_with_backend():\n    \"\"\"Register this bridge service with the web backend\"\"\"\n    try:\n        response = requests.post(\n            f\"{WEB_BACKEND_URL}/bridge-services\",\n            json={\n                \"name\": \"Local Bridge Service\",\n                \"host\": \"localhost\",\n                \"port\": BRIDGE_PORT,\n                \"adapter_type\": ADAPTER_TYPE\n            },\n            timeout=5\n        )\n        if response.status_code == 200:\n            logger.info(\"Successfully registered with backend\")\n        else:\n            logger.warning(f\"Failed to register with backend: {response.status_code}\")\n    except Exception as e:\n        logger.warning(f\"Could not register with backend: {e}\")\n\n@app.on_event(\"startup\")\nasync def startup_event():\n    \"\"\"Run on service startup\"\"\"\n    logger.info(\"ECM Bridge Service starting...\")\n    logger.info(f\"Adapter type: {ADAPTER_TYPE}\")\n    \n    # Try to register with backend (optional)\n    await register_with_backend()\n\nif __name__ == \"__main__\":\n    print(\"=\"*60)\n    print(\"ECM Bridge Service for Ford Vehicles\")\n    print(\"=\"*60)\n    print(f\"Starting on port {BRIDGE_PORT}...\")\n    print(f\"Adapter type: {ADAPTER_TYPE}\")\n    print(\"\\nThis service connects to local J2534/OBD-II hardware.\")\n    print(\"Make sure your adapter is connected before flashing.\\n\")\n    \n    uvicorn.run(app, host=\"0.0.0.0\", port=BRIDGE_PORT, log_level=\"info\")"}, {"path": "/app/frontend/src/App.js", "content": "import { useState, useEffect } from \"react\";\nimport \"@/App.css\";\nimport { BrowserRouter, Routes, Route } from \"react-router-dom\";\nimport Dashboard from \"./pages/Dashboard\";\nimport VehicleDetail from \"./pages/VehicleDetail\";\nimport FlashWizard from \"./pages/FlashWizard\";\nimport FirmwareManagement from \"./pages/FirmwareManagement\";\nimport FlashHistory from \"./pages/FlashHistory\";\nimport { Toaster } from \"@/components/ui/sonner\";\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <BrowserRouter>\n        <Routes>\n          <Route path=\"/\" element={<Dashboard />} />\n          <Route path=\"/vehicle/:vehicleId\" element={<VehicleDetail />} />\n          <Route path=\"/flash/:vehicleId\" element={<FlashWizard />} />\n          <Route path=\"/firmware\" element={<FirmwareManagement />} />\n          <Route path=\"/history\" element={<FlashHistory />} />\n        </Routes>\n      </BrowserRouter>\n      <Toaster position=\"top-right\" />\n    </div>\n  );\n}\n\nexport default App;"}, {"path": "/app/frontend/src/App.css", "content": "@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap');\n\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: 'Inter', sans-serif;\n  background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);\n  color: #e0e6ed;\n  min-height: 100vh;\n}\n\nh1, h2, h3, h4, h5, h6 {\n  font-family: 'Space Grotesk', sans-serif;\n}\n\n.App {\n  min-height: 100vh;\n}\n\n/* Custom scrollbar */\n::-webkit-scrollbar {\n  width: 8px;\n  height: 8px;\n}\n\n::-webkit-scrollbar-track {\n  background: #1a1f3a;\n}\n\n::-webkit-scrollbar-thumb {\n  background: #3b82f6;\n  border-radius: 4px;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: #2563eb;\n}\n\n/* Glass effect cards */\n.glass-card {\n  background: rgba(30, 41, 59, 0.4);\n  backdrop-filter: blur(12px);\n  border: 1px solid rgba(148, 163, 184, 0.1);\n  border-radius: 12px;\n  transition: transform 0.2s, box-shadow 0.2s;\n}\n\n.glass-card:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);\n}\n\n/* Status indicators */\n.status-dot {\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  display: inline-block;\n  animation: pulse 2s infinite;\n}\n\n.status-online {\n  background: #10b981;\n}\n\n.status-offline {\n  background: #ef4444;\n}\n\n.status-pending {\n  background: #f59e0b;\n}\n\n@keyframes pulse {\n  0%, 100% {\n    opacity: 1;\n  }\n  50% {\n    opacity: 0.5;\n  }\n}\n\n/* Button styles */\n.btn-primary {\n  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n  color: white;\n  border: none;\n  padding: 10px 24px;\n  border-radius: 8px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: transform 0.2s, box-shadow 0.2s;\n}\n\n.btn-primary:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);\n}\n\n.btn-secondary {\n  background: rgba(148, 163, 184, 0.1);\n  color: #e0e6ed;\n  border: 1px solid rgba(148, 163, 184, 0.2);\n  padding: 10px 24px;\n  border-radius: 8px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: background 0.2s, border-color 0.2s;\n}\n\n.btn-secondary:hover {\n  background: rgba(148, 163, 184, 0.2);\n  border-color: rgba(148, 163, 184, 0.3);\n}\n\n/* Progress bar */\n.progress-bar {\n  height: 8px;\n  background: rgba(148, 163, 184, 0.1);\n  border-radius: 4px;\n  overflow: hidden;\n}\n\n.progress-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);\n  transition: width 0.3s ease;\n}\n\n/* Badge styles */\n.badge {\n  display: inline-block;\n  padding: 4px 12px;\n  border-radius: 12px;\n  font-size: 12px;\n  font-weight: 500;\n}\n\n.badge-success {\n  background: rgba(16, 185, 129, 0.2);\n  color: #10b981;\n}\n\n.badge-error {\n  background: rgba(239, 68, 68, 0.2);\n  color: #ef4444;\n}\n\n.badge-warning {\n  background: rgba(245, 158, 11, 0.2);\n  color: #f59e0b;\n}\n\n.badge-info {\n  background: rgba(59, 130, 246, 0.2);\n  color: #3b82f6;\n}"}, {"path": "/app/frontend/src/pages/Dashboard.js", "content": "import { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { toast } from 'sonner';\nimport { Car, Plus, Wrench, History, Upload, Activity } from 'lucide-react';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\nconst API = `${BACKEND_URL}/api`;\n\nconst Dashboard = () => {\n  const navigate = useNavigate();\n  const [vehicles, setVehicles] = useState([]);\n  const [bridgeServices, setBridgeServices] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [showAddVehicle, setShowAddVehicle] = useState(false);\n  const [newVehicle, setNewVehicle] = useState({\n    vin: '',\n    model: '',\n    year: new Date().getFullYear(),\n    ecm_type: 'PCM'\n  });\n\n  useEffect(() => {\n    loadData();\n  }, []);\n\n  const loadData = async () => {\n    try {\n      const [vehiclesRes, bridgeRes] = await Promise.all([\n        axios.get(`${API}/vehicles`),\n        axios.get(`${API}/bridge-services`)\n      ]);\n      setVehicles(vehiclesRes.data);\n      setBridgeServices(bridgeRes.data);\n    } catch (error) {\n      console.error('Error loading data:', error);\n      toast.error('Failed to load dashboard data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleAddVehicle = async (e) => {\n    e.preventDefault();\n    try {\n      await axios.post(`${API}/vehicles`, newVehicle);\n      toast.success('Vehicle added successfully');\n      setShowAddVehicle(false);\n      setNewVehicle({ vin: '', model: '', year: new Date().getFullYear(), ecm_type: 'PCM' });\n      loadData();\n    } catch (error) {\n      console.error('Error adding vehicle:', error);\n      toast.error('Failed to add vehicle');\n    }\n  };\n\n  const activeBridge = bridgeServices.find(b => b.status === 'online');\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Activity className=\"w-12 h-12 animate-spin mx-auto mb-4 text-blue-500\" />\n          <p className=\"text-lg\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen p-6\">\n      {/* Header */}\n      <header className=\"mb-8\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <div>\n            <h1 className=\"text-4xl font-bold text-white mb-2\" data-testid=\"dashboard-title\">Ford ECM Flash Tool</h1>\n            <p className=\"text-gray-400\">Professional ECM Programming Solution</p>\n          </div>\n          <div className=\"flex gap-3\">\n            <Button\n              onClick={() => navigate('/firmware')}\n              variant=\"outline\"\n              className=\"bg-slate-800 border-slate-700 hover:bg-slate-700\"\n              data-testid=\"firmware-management-btn\"\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              Firmware\n            </Button>\n            <Button\n              onClick={() => navigate('/history')}\n              variant=\"outline\"\n              className=\"bg-slate-800 border-slate-700 hover:bg-slate-700\"\n              data-testid=\"flash-history-btn\"\n            >\n              <History className=\"w-4 h-4 mr-2\" />\n              History\n            </Button>\n          </div>\n        </div>\n\n        {/* Bridge Service Status */}\n        <Card className=\"glass-card border-slate-700\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className={`status-dot ${activeBridge ? 'status-online' : 'status-offline'}`} />\n                <div>\n                  <p className=\"text-sm text-gray-400\">Bridge Service Status</p>\n                  <p className=\"text-lg font-semibold text-white\" data-testid=\"bridge-status\">\n                    {activeBridge ? `Connected - ${activeBridge.name}` : 'Not Connected'}\n                  </p>\n                </div>\n              </div>\n              {activeBridge && (\n                <div className=\"text-right\">\n                  <p className=\"text-sm text-gray-400\">Adapter Type</p>\n                  <p className=\"text-lg font-semibold text-white\">{activeBridge.adapter_type}</p>\n                </div>\n              )}\n            </div>\n            {!activeBridge && (\n              <div className=\"mt-4 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg\">\n                <p className=\"text-amber-400 text-sm\">\n                  <strong>Setup Required:</strong> Run the bridge service on your local machine to connect to hardware adapters.\n                  <br />\n                  <code className=\"text-xs mt-2 block\">python bridge_service.py</code>\n                </p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </header>\n\n      {/* Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8\">\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <Car className=\"w-5 h-5 mr-2 text-blue-400\" />\n              Total Vehicles\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold text-white\" data-testid=\"total-vehicles\">{vehicles.length}</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <Wrench className=\"w-5 h-5 mr-2 text-green-400\" />\n              Ready to Flash\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold text-white\">{activeBridge ? vehicles.length : 0}</p>\n          </CardContent>\n        </Card>\n\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <Activity className=\"w-5 h-5 mr-2 text-purple-400\" />\n              System Status\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-3xl font-bold text-white\" data-testid=\"system-status\">\n              {activeBridge ? 'Online' : 'Offline'}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Vehicles Section */}\n      <div className=\"mb-8\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-2xl font-bold text-white\">Vehicles</h2>\n          <Dialog open={showAddVehicle} onOpenChange={setShowAddVehicle}>\n            <DialogTrigger asChild>\n              <Button className=\"btn-primary\" data-testid=\"add-vehicle-btn\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Vehicle\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"bg-slate-800 border-slate-700\">\n              <DialogHeader>\n                <DialogTitle className=\"text-white\">Add New Vehicle</DialogTitle>\n              </DialogHeader>\n              <form onSubmit={handleAddVehicle} className=\"space-y-4\">\n                <div>\n                  <Label className=\"text-gray-300\">VIN</Label>\n                  <Input\n                    value={newVehicle.vin}\n                    onChange={(e) => setNewVehicle({ ...newVehicle, vin: e.target.value })}\n                    placeholder=\"1FAHP3K29CL123456\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"vin-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">Model</Label>\n                  <Input\n                    value={newVehicle.model}\n                    onChange={(e) => setNewVehicle({ ...newVehicle, model: e.target.value })}\n                    placeholder=\"Mustang GT\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"model-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">Year</Label>\n                  <Input\n                    type=\"number\"\n                    value={newVehicle.year}\n                    onChange={(e) => setNewVehicle({ ...newVehicle, year: parseInt(e.target.value) })}\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"year-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">ECM Type</Label>\n                  <Input\n                    value={newVehicle.ecm_type}\n                    onChange={(e) => setNewVehicle({ ...newVehicle, ecm_type: e.target.value })}\n                    placeholder=\"PCM, TCM, BCM\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"ecm-type-input\"\n                  />\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button type=\"submit\" className=\"btn-primary flex-1\" data-testid=\"submit-vehicle-btn\">\n                    Add Vehicle\n                  </Button>\n                  <Button\n                    type=\"button\"\n                    onClick={() => setShowAddVehicle(false)}\n                    variant=\"outline\"\n                    className=\"flex-1 bg-slate-700 border-slate-600\"\n                    data-testid=\"cancel-vehicle-btn\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {vehicles.length === 0 ? (\n          <Card className=\"glass-card border-slate-700\">\n            <CardContent className=\"py-12 text-center\">\n              <Car className=\"w-16 h-16 mx-auto mb-4 text-gray-600\" />\n              <p className=\"text-gray-400 mb-4\">No vehicles added yet</p>\n              <Button onClick={() => setShowAddVehicle(true)} className=\"btn-primary\" data-testid=\"add-first-vehicle-btn\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Your First Vehicle\n              </Button>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {vehicles.map((vehicle) => (\n              <Card\n                key={vehicle.id}\n                className=\"glass-card border-slate-700 cursor-pointer\"\n                onClick={() => navigate(`/vehicle/${vehicle.id}`)}\n                data-testid={`vehicle-card-${vehicle.id}`}\n              >\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-start justify-between mb-4\">\n                    <div>\n                      <h3 className=\"text-xl font-bold text-white mb-1\">\n                        {vehicle.year} {vehicle.model}\n                      </h3>\n                      <p className=\"text-sm text-gray-400\">{vehicle.vin}</p>\n                    </div>\n                    <Car className=\"w-8 h-8 text-blue-400\" />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-sm\">\n                      <span className=\"text-gray-400\">ECM Type:</span>\n                      <span className=\"text-white font-medium\">{vehicle.ecm_type}</span>\n                    </div>\n                    {vehicle.calibration_id && (\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-gray-400\">Calibration:</span>\n                        <span className=\"text-white font-medium\">{vehicle.calibration_id}</span>\n                      </div>\n                    )}\n                    {vehicle.last_connected && (\n                      <div className=\"flex justify-between text-sm\">\n                        <span className=\"text-gray-400\">Last Connected:</span>\n                        <span className=\"text-white font-medium\">\n                          {new Date(vehicle.last_connected).toLocaleDateString()}\n                        </span>\n                      </div>\n                    )}\n                  </div>\n                  <Button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      navigate(`/flash/${vehicle.id}`);\n                    }}\n                    className=\"w-full mt-4 btn-primary\"\n                    disabled={!activeBridge}\n                    data-testid={`flash-btn-${vehicle.id}`}\n                  >\n                    <Wrench className=\"w-4 h-4 mr-2\" />\n                    Flash ECM\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default Dashboard;"}, {"path": "/app/frontend/src/pages/VehicleDetail.js", "content": "import { useState, useEffect } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport axios from 'axios';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { toast } from 'sonner';\nimport { ArrowLeft, Car, Wrench, Database, AlertTriangle, Trash2, Activity } from 'lucide-react';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\nconst API = `${BACKEND_URL}/api`;\n\nconst VehicleDetail = () => {\n  const { vehicleId } = useParams();\n  const navigate = useNavigate();\n  const [vehicle, setVehicle] = useState(null);\n  const [ecmData, setEcmData] = useState(null);\n  const [backups, setBackups] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [reading, setReading] = useState(false);\n  const [creatingBackup, setCreatingBackup] = useState(false);\n\n  useEffect(() => {\n    loadVehicleData();\n  }, [vehicleId]);\n\n  const loadVehicleData = async () => {\n    try {\n      const [vehicleRes, backupsRes] = await Promise.all([\n        axios.get(`${API}/vehicles/${vehicleId}`),\n        axios.get(`${API}/backups?vehicle_id=${vehicleId}`)\n      ]);\n      setVehicle(vehicleRes.data);\n      setBackups(backupsRes.data);\n    } catch (error) {\n      console.error('Error loading vehicle:', error);\n      toast.error('Failed to load vehicle data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleReadECM = async () => {\n    setReading(true);\n    try {\n      const response = await axios.post(`${API}/ecm/read/${vehicleId}`);\n      setEcmData(response.data);\n      toast.success('ECM data read successfully');\n      loadVehicleData();\n    } catch (error) {\n      console.error('Error reading ECM:', error);\n      toast.error('Failed to read ECM data');\n    } finally {\n      setReading(false);\n    }\n  };\n\n  const handleCreateBackup = async () => {\n    setCreatingBackup(true);\n    try {\n      await axios.post(`${API}/backups?vehicle_id=${vehicleId}&description=Manual backup`);\n      toast.success('Backup created successfully');\n      loadVehicleData();\n    } catch (error) {\n      console.error('Error creating backup:', error);\n      toast.error('Failed to create backup');\n    } finally {\n      setCreatingBackup(false);\n    }\n  };\n\n  const handleRestoreBackup = async (backupId) => {\n    if (!window.confirm('Are you sure you want to restore this backup? This will overwrite current ECM data.')) {\n      return;\n    }\n    try {\n      await axios.post(`${API}/backups/${backupId}/restore`);\n      toast.success('Backup restored successfully');\n    } catch (error) {\n      console.error('Error restoring backup:', error);\n      toast.error('Failed to restore backup');\n    }\n  };\n\n  const handleDeleteVehicle = async () => {\n    if (!window.confirm('Are you sure you want to delete this vehicle?')) {\n      return;\n    }\n    try {\n      await axios.delete(`${API}/vehicles/${vehicleId}`);\n      toast.success('Vehicle deleted successfully');\n      navigate('/');\n    } catch (error) {\n      console.error('Error deleting vehicle:', error);\n      toast.error('Failed to delete vehicle');\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Activity className=\"w-12 h-12 animate-spin mx-auto mb-4 text-blue-500\" />\n          <p className=\"text-lg\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!vehicle) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <p className=\"text-xl text-gray-400 mb-4\">Vehicle not found</p>\n          <Button onClick={() => navigate('/')} className=\"btn-primary\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen p-6\">\n      {/* Header */}\n      <div className=\"mb-8\">\n        <Button\n          onClick={() => navigate('/')}\n          variant=\"outline\"\n          className=\"mb-4 bg-slate-800 border-slate-700 hover:bg-slate-700\"\n          data-testid=\"back-to-dashboard-btn\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Back to Dashboard\n        </Button>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-4xl font-bold text-white mb-2\" data-testid=\"vehicle-title\">\n              {vehicle.year} Ford {vehicle.model}\n            </h1>\n            <p className=\"text-gray-400\" data-testid=\"vehicle-vin\">VIN: {vehicle.vin}</p>\n          </div>\n          <div className=\"flex gap-3\">\n            <Button\n              onClick={() => navigate(`/flash/${vehicleId}`)}\n              className=\"btn-primary\"\n              data-testid=\"flash-ecm-btn\"\n            >\n              <Wrench className=\"w-4 h-4 mr-2\" />\n              Flash ECM\n            </Button>\n            <Button\n              onClick={handleDeleteVehicle}\n              variant=\"destructive\"\n              className=\"bg-red-600 hover:bg-red-700\"\n              data-testid=\"delete-vehicle-btn\"\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" />\n              Delete\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Vehicle Info */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <Car className=\"w-5 h-5 mr-2 text-blue-400\" />\n              Vehicle Information\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-gray-400\">Make:</span>\n              <span className=\"text-white font-medium\">{vehicle.make}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-gray-400\">Model:</span>\n              <span className=\"text-white font-medium\">{vehicle.model}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-gray-400\">Year:</span>\n              <span className=\"text-white font-medium\">{vehicle.year}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-gray-400\">ECM Type:</span>\n              <span className=\"text-white font-medium\">{vehicle.ecm_type}</span>\n            </div>\n            {vehicle.last_connected && (\n              <div className=\"flex justify-between\">\n                <span className=\"text-gray-400\">Last Connected:</span>\n                <span className=\"text-white font-medium\">\n                  {new Date(vehicle.last_connected).toLocaleString()}\n                </span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"flex items-center text-white\">\n                <Database className=\"w-5 h-5 mr-2 text-green-400\" />\n                ECM Data\n              </CardTitle>\n              <Button\n                onClick={handleReadECM}\n                disabled={reading}\n                size=\"sm\"\n                className=\"btn-primary\"\n                data-testid=\"read-ecm-btn\"\n              >\n                {reading ? 'Reading...' : 'Read ECM'}\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {ecmData || vehicle.calibration_id ? (\n              <>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-400\">Calibration ID:</span>\n                  <span className=\"text-white font-medium\" data-testid=\"calibration-id\">\n                    {ecmData?.calibration_id || vehicle.calibration_id}\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-400\">Software Version:</span>\n                  <span className=\"text-white font-medium\" data-testid=\"software-version\">\n                    {ecmData?.software_version || vehicle.software_version}\n                  </span>\n                </div>\n                {ecmData?.hardware_version && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-400\">Hardware Version:</span>\n                    <span className=\"text-white font-medium\">{ecmData.hardware_version}</span>\n                  </div>\n                )}\n                {ecmData?.battery_voltage && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-400\">Battery Voltage:</span>\n                    <span className=\"text-white font-medium\">{ecmData.battery_voltage}V</span>\n                  </div>\n                )}\n                {ecmData?.dtc_codes && ecmData.dtc_codes.length > 0 && (\n                  <div>\n                    <div className=\"flex items-center gap-2 text-amber-400 mb-2\">\n                      <AlertTriangle className=\"w-4 h-4\" />\n                      <span className=\"font-medium\">Diagnostic Codes:</span>\n                    </div>\n                    <div className=\"flex gap-2 flex-wrap\">\n                      {ecmData.dtc_codes.map((code) => (\n                        <span key={code} className=\"badge badge-warning\" data-testid={`dtc-code-${code}`}>\n                          {code}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </>\n            ) : (\n              <p className=\"text-gray-400 text-center py-4\">No ECM data available. Click \"Read ECM\" to fetch data.</p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Backups */}\n      <Card className=\"glass-card border-slate-700\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"flex items-center text-white\">\n              <Database className=\"w-5 h-5 mr-2 text-purple-400\" />\n              ECM Backups\n            </CardTitle>\n            <Button\n              onClick={handleCreateBackup}\n              disabled={creatingBackup}\n              size=\"sm\"\n              className=\"btn-primary\"\n              data-testid=\"create-backup-btn\"\n            >\n              {creatingBackup ? 'Creating...' : 'Create Backup'}\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {backups.length === 0 ? (\n            <p className=\"text-gray-400 text-center py-8\">No backups available</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {backups.map((backup) => (\n                <div\n                  key={backup.id}\n                  className=\"flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700\"\n                  data-testid={`backup-item-${backup.id}`}\n                >\n                  <div>\n                    <p className=\"text-white font-medium\">{backup.description}</p>\n                    <p className=\"text-sm text-gray-400\">\n                      {new Date(backup.created_at).toLocaleString()} \u2022 {(backup.size / 1024).toFixed(2)} KB\n                    </p>\n                  </div>\n                  <Button\n                    onClick={() => handleRestoreBackup(backup.id)}\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"bg-slate-700 border-slate-600 hover:bg-slate-600\"\n                    data-testid={`restore-backup-${backup.id}`}\n                  >\n                    Restore\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default VehicleDetail;"}, {"path": "/app/frontend/src/pages/FlashWizard.js", "content": "import { useState, useEffect } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport axios from 'axios';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Progress } from '@/components/ui/progress';\nimport { toast } from 'sonner';\nimport { ArrowLeft, Check, AlertTriangle, Zap, ShieldCheck } from 'lucide-react';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\nconst API = `${BACKEND_URL}/api`;\n\nconst FlashWizard = () => {\n  const { vehicleId } = useParams();\n  const navigate = useNavigate();\n  const [vehicle, setVehicle] = useState(null);\n  const [firmware, setFirmware] = useState([]);\n  const [selectedFirmware, setSelectedFirmware] = useState(null);\n  const [step, setStep] = useState(1); // 1: Select, 2: Safety, 3: Flash, 4: Complete\n  const [safetyChecks, setSafetyChecks] = useState({\n    batteryVoltage: false,\n    connection: false,\n    backup: false,\n    compatibility: false\n  });\n  const [flashing, setFlashing] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [sessionId, setSessionId] = useState(null);\n\n  useEffect(() => {\n    loadData();\n  }, [vehicleId]);\n\n  const loadData = async () => {\n    try {\n      const [vehicleRes, firmwareRes] = await Promise.all([\n        axios.get(`${API}/vehicles/${vehicleId}`),\n        axios.get(`${API}/firmware`)\n      ]);\n      setVehicle(vehicleRes.data);\n      setFirmware(firmwareRes.data);\n    } catch (error) {\n      console.error('Error loading data:', error);\n      toast.error('Failed to load data');\n    }\n  };\n\n  const performSafetyChecks = async () => {\n    // Simulate safety checks\n    setSafetyChecks({ batteryVoltage: false, connection: false, backup: false, compatibility: false });\n    \n    await new Promise(resolve => setTimeout(resolve, 500));\n    setSafetyChecks(prev => ({ ...prev, batteryVoltage: true }));\n    \n    await new Promise(resolve => setTimeout(resolve, 500));\n    setSafetyChecks(prev => ({ ...prev, connection: true }));\n    \n    await new Promise(resolve => setTimeout(resolve, 500));\n    setSafetyChecks(prev => ({ ...prev, backup: true }));\n    \n    await new Promise(resolve => setTimeout(resolve, 500));\n    setSafetyChecks(prev => ({ ...prev, compatibility: true }));\n  };\n\n  const startFlash = async () => {\n    setFlashing(true);\n    setStep(3);\n    \n    try {\n      // Create flash session\n      const sessionRes = await axios.post(`${API}/flash-sessions`, {\n        vehicle_id: vehicleId,\n        firmware_id: selectedFirmware.id\n      });\n      setSessionId(sessionRes.data.id);\n      \n      // Update session to in_progress\n      await axios.patch(`${API}/flash-sessions/${sessionRes.data.id}?status=in_progress&progress=0`);\n      \n      // Simulate flashing progress\n      for (let i = 0; i <= 100; i += 2) {\n        await new Promise(resolve => setTimeout(resolve, 100));\n        setProgress(i);\n        \n        if (i % 20 === 0) {\n          await axios.patch(`${API}/flash-sessions/${sessionRes.data.id}?status=in_progress&progress=${i}`);\n        }\n      }\n      \n      // Mark as completed\n      await axios.patch(`${API}/flash-sessions/${sessionRes.data.id}?status=completed&progress=100`);\n      \n      setStep(4);\n      toast.success('ECM flashed successfully!');\n    } catch (error) {\n      console.error('Error during flash:', error);\n      toast.error('Flash failed. Please try again.');\n      if (sessionId) {\n        await axios.patch(`${API}/flash-sessions/${sessionId}?status=failed&progress=${progress}&error_message=${error.message}`);\n      }\n    } finally {\n      setFlashing(false);\n    }\n  };\n\n  const handleNext = async () => {\n    if (step === 1 && selectedFirmware) {\n      setStep(2);\n      await performSafetyChecks();\n    } else if (step === 2) {\n      await startFlash();\n    }\n  };\n\n  const compatibleFirmware = firmware.filter(f =>\n    f.compatible_models.includes(vehicle?.model) &&\n    f.compatible_years.includes(vehicle?.year)\n  );\n\n  if (!vehicle) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <p className=\"text-lg\">Loading...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen p-6\">\n      <div className=\"max-w-4xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <Button\n            onClick={() => navigate('/')}\n            variant=\"outline\"\n            className=\"mb-4 bg-slate-800 border-slate-700 hover:bg-slate-700\"\n            data-testid=\"back-btn\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back\n          </Button>\n          <h1 className=\"text-4xl font-bold text-white mb-2\" data-testid=\"wizard-title\">ECM Flash Wizard</h1>\n          <p className=\"text-gray-400\">{vehicle.year} Ford {vehicle.model} \u2022 {vehicle.vin}</p>\n        </div>\n\n        {/* Progress Steps */}\n        <div className=\"flex items-center justify-between mb-8\">\n          {['Select Firmware', 'Safety Checks', 'Flashing', 'Complete'].map((label, index) => (\n            <div key={index} className=\"flex items-center\">\n              <div\n                className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold ${\n                  step > index + 1\n                    ? 'bg-green-500 text-white'\n                    : step === index + 1\n                    ? 'bg-blue-500 text-white'\n                    : 'bg-slate-700 text-gray-400'\n                }`}\n                data-testid={`step-${index + 1}`}\n              >\n                {step > index + 1 ? <Check className=\"w-5 h-5\" /> : index + 1}\n              </div>\n              <span className=\"ml-2 text-sm text-gray-300 hidden md:block\">{label}</span>\n              {index < 3 && <div className=\"w-16 h-1 bg-slate-700 mx-4\" />}\n            </div>\n          ))}\n        </div>\n\n        {/* Step Content */}\n        {step === 1 && (\n          <Card className=\"glass-card border-slate-700\">\n            <CardHeader>\n              <CardTitle className=\"text-white\">Select Firmware</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {compatibleFirmware.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <p className=\"text-gray-400 mb-4\">No compatible firmware available</p>\n                  <Button onClick={() => navigate('/firmware')} className=\"btn-primary\" data-testid=\"upload-firmware-btn\">\n                    Upload Firmware\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {compatibleFirmware.map((fw) => (\n                    <div\n                      key={fw.id}\n                      onClick={() => setSelectedFirmware(fw)}\n                      className={`p-4 rounded-lg border-2 cursor-pointer ${\n                        selectedFirmware?.id === fw.id\n                          ? 'border-blue-500 bg-blue-500/10'\n                          : 'border-slate-700 bg-slate-800/50 hover:border-slate-600'\n                      }`}\n                      data-testid={`firmware-option-${fw.id}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <h3 className=\"text-white font-semibold\">{fw.name}</h3>\n                          <p className=\"text-sm text-gray-400\">Version {fw.version}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-gray-400\">Size: {(fw.file_size / 1024).toFixed(2)} KB</p>\n                          <p className=\"text-xs text-gray-500\">Checksum: {fw.checksum}</p>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n              {compatibleFirmware.length > 0 && (\n                <Button\n                  onClick={handleNext}\n                  disabled={!selectedFirmware}\n                  className=\"w-full mt-6 btn-primary\"\n                  data-testid=\"next-step-btn\"\n                >\n                  Next: Safety Checks\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {step === 2 && (\n          <Card className=\"glass-card border-slate-700\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center text-white\">\n                <ShieldCheck className=\"w-5 h-5 mr-2 text-green-400\" />\n                Safety Checks\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4 mb-6\">\n                {[\n                  { key: 'batteryVoltage', label: 'Battery Voltage (12V+)' },\n                  { key: 'connection', label: 'Stable Connection' },\n                  { key: 'backup', label: 'ECM Backup Created' },\n                  { key: 'compatibility', label: 'Firmware Compatibility' }\n                ].map(({ key, label }) => (\n                  <div key={key} className=\"flex items-center justify-between p-3 bg-slate-800/50 rounded-lg\">\n                    <span className=\"text-gray-300\">{label}</span>\n                    {safetyChecks[key] ? (\n                      <Check className=\"w-5 h-5 text-green-400\" data-testid={`check-${key}-pass`} />\n                    ) : (\n                      <div className=\"w-5 h-5 border-2 border-gray-600 rounded-full animate-pulse\" />\n                    )}\n                  </div>\n                ))}\n              </div>\n              {Object.values(safetyChecks).every(Boolean) && (\n                <div className=\"p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg mb-6\">\n                  <div className=\"flex items-start gap-3\">\n                    <AlertTriangle className=\"w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5\" />\n                    <div>\n                      <p className=\"text-amber-400 font-semibold mb-1\">Warning</p>\n                      <p className=\"text-sm text-amber-300\">\n                        Do not turn off the ignition or disconnect during flashing. Ensure vehicle remains stable.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n              <Button\n                onClick={handleNext}\n                disabled={!Object.values(safetyChecks).every(Boolean)}\n                className=\"w-full btn-primary\"\n                data-testid=\"start-flash-btn\"\n              >\n                <Zap className=\"w-4 h-4 mr-2\" />\n                Start Flashing\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {step === 3 && (\n          <Card className=\"glass-card border-slate-700\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center text-white\">\n                <Zap className=\"w-5 h-5 mr-2 text-blue-400 animate-pulse\" />\n                Flashing in Progress\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-center py-8\">\n                <div className=\"w-24 h-24 mx-auto mb-6 relative\">\n                  <div className=\"absolute inset-0 border-4 border-blue-500/30 rounded-full\"></div>\n                  <div className=\"absolute inset-0 border-4 border-blue-500 rounded-full animate-spin\" style={{ borderTopColor: 'transparent' }}></div>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <span className=\"text-2xl font-bold text-white\" data-testid=\"flash-progress\">{progress}%</span>\n                  </div>\n                </div>\n                <Progress value={progress} className=\"mb-4\" />\n                <p className=\"text-gray-400 mb-2\">Programming ECM...</p>\n                <p className=\"text-sm text-amber-400\">Do not turn off ignition or disconnect</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {step === 4 && (\n          <Card className=\"glass-card border-slate-700\">\n            <CardContent className=\"py-12 text-center\">\n              <div className=\"w-20 h-20 mx-auto mb-6 bg-green-500 rounded-full flex items-center justify-center\">\n                <Check className=\"w-10 h-10 text-white\" />\n              </div>\n              <h2 className=\"text-3xl font-bold text-white mb-2\" data-testid=\"flash-complete-title\">Flash Complete!</h2>\n              <p className=\"text-gray-400 mb-8\">ECM has been successfully programmed with new firmware.</p>\n              <div className=\"flex gap-4 justify-center\">\n                <Button onClick={() => navigate('/')} className=\"btn-primary\" data-testid=\"back-dashboard-btn\">\n                  Back to Dashboard\n                </Button>\n                <Button\n                  onClick={() => navigate(`/vehicle/${vehicleId}`)}\n                  variant=\"outline\"\n                  className=\"bg-slate-700 border-slate-600 hover:bg-slate-600\"\n                  data-testid=\"view-vehicle-btn\"\n                >\n                  View Vehicle Details\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default FlashWizard;"}, {"path": "/app/frontend/src/pages/FirmwareManagement.js", "content": "import { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { toast } from 'sonner';\nimport { ArrowLeft, Upload, Trash2, File } from 'lucide-react';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\nconst API = `${BACKEND_URL}/api`;\n\nconst FirmwareManagement = () => {\n  const navigate = useNavigate();\n  const [firmware, setFirmware] = useState([]);\n  const [uploading, setUploading] = useState(false);\n  const [uploadData, setUploadData] = useState({\n    name: '',\n    version: '',\n    compatible_models: '',\n    compatible_years: '',\n    file: null\n  });\n\n  useEffect(() => {\n    loadFirmware();\n  }, []);\n\n  const loadFirmware = async () => {\n    try {\n      const response = await axios.get(`${API}/firmware`);\n      setFirmware(response.data);\n    } catch (error) {\n      console.error('Error loading firmware:', error);\n      toast.error('Failed to load firmware');\n    }\n  };\n\n  const handleUpload = async (e) => {\n    e.preventDefault();\n    \n    if (!uploadData.file) {\n      toast.error('Please select a file');\n      return;\n    }\n\n    setUploading(true);\n    const formData = new FormData();\n    formData.append('name', uploadData.name);\n    formData.append('version', uploadData.version);\n    formData.append('compatible_models', uploadData.compatible_models);\n    formData.append('compatible_years', uploadData.compatible_years);\n    formData.append('file', uploadData.file);\n\n    try {\n      await axios.post(`${API}/firmware`, formData, {\n        headers: { 'Content-Type': 'multipart/form-data' }\n      });\n      toast.success('Firmware uploaded successfully');\n      setUploadData({ name: '', version: '', compatible_models: '', compatible_years: '', file: null });\n      loadFirmware();\n    } catch (error) {\n      console.error('Error uploading firmware:', error);\n      toast.error('Failed to upload firmware');\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const handleDelete = async (firmwareId) => {\n    if (!window.confirm('Are you sure you want to delete this firmware?')) {\n      return;\n    }\n    try {\n      await axios.delete(`${API}/firmware/${firmwareId}`);\n      toast.success('Firmware deleted successfully');\n      loadFirmware();\n    } catch (error) {\n      console.error('Error deleting firmware:', error);\n      toast.error('Failed to delete firmware');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen p-6\">\n      <div className=\"max-w-6xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <Button\n            onClick={() => navigate('/')}\n            variant=\"outline\"\n            className=\"mb-4 bg-slate-800 border-slate-700 hover:bg-slate-700\"\n            data-testid=\"back-to-dashboard-btn\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Dashboard\n          </Button>\n          <h1 className=\"text-4xl font-bold text-white mb-2\" data-testid=\"firmware-title\">Firmware Management</h1>\n          <p className=\"text-gray-400\">Upload and manage ECM firmware files</p>\n        </div>\n\n        {/* Upload Form */}\n        <Card className=\"glass-card border-slate-700 mb-8\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <Upload className=\"w-5 h-5 mr-2 text-blue-400\" />\n              Upload New Firmware\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleUpload} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-gray-300\">Firmware Name</Label>\n                  <Input\n                    value={uploadData.name}\n                    onChange={(e) => setUploadData({ ...uploadData, name: e.target.value })}\n                    placeholder=\"Ford Mustang GT PCM\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"firmware-name-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">Version</Label>\n                  <Input\n                    value={uploadData.version}\n                    onChange={(e) => setUploadData({ ...uploadData, version: e.target.value })}\n                    placeholder=\"1.2.3\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"firmware-version-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">Compatible Models (comma-separated)</Label>\n                  <Input\n                    value={uploadData.compatible_models}\n                    onChange={(e) => setUploadData({ ...uploadData, compatible_models: e.target.value })}\n                    placeholder=\"Mustang GT,F-150,Explorer\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"compatible-models-input\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-gray-300\">Compatible Years (comma-separated)</Label>\n                  <Input\n                    value={uploadData.compatible_years}\n                    onChange={(e) => setUploadData({ ...uploadData, compatible_years: e.target.value })}\n                    placeholder=\"2020,2021,2022,2023\"\n                    required\n                    className=\"bg-slate-900 border-slate-700 text-white\"\n                    data-testid=\"compatible-years-input\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-gray-300\">Firmware File (.bin, .hex)</Label>\n                <Input\n                  type=\"file\"\n                  onChange={(e) => setUploadData({ ...uploadData, file: e.target.files[0] })}\n                  accept=\".bin,.hex\"\n                  required\n                  className=\"bg-slate-900 border-slate-700 text-white\"\n                  data-testid=\"firmware-file-input\"\n                />\n              </div>\n              <Button\n                type=\"submit\"\n                disabled={uploading}\n                className=\"w-full btn-primary\"\n                data-testid=\"upload-firmware-btn\"\n              >\n                {uploading ? 'Uploading...' : 'Upload Firmware'}\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        {/* Firmware List */}\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">Available Firmware</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {firmware.length === 0 ? (\n              <p className=\"text-gray-400 text-center py-8\">No firmware uploaded yet</p>\n            ) : (\n              <div className=\"space-y-3\">\n                {firmware.map((fw) => (\n                  <div\n                    key={fw.id}\n                    className=\"flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700\"\n                    data-testid={`firmware-item-${fw.id}`}\n                  >\n                    <div className=\"flex items-start gap-4\">\n                      <File className=\"w-8 h-8 text-blue-400 flex-shrink-0\" />\n                      <div>\n                        <h3 className=\"text-white font-semibold\">{fw.name}</h3>\n                        <p className=\"text-sm text-gray-400\">Version {fw.version}</p>\n                        <div className=\"flex gap-4 mt-2 text-xs text-gray-500\">\n                          <span>Models: {fw.compatible_models.join(', ')}</span>\n                          <span>Years: {fw.compatible_years.join(', ')}</span>\n                        </div>\n                        <div className=\"flex gap-4 mt-1 text-xs text-gray-500\">\n                          <span>Size: {(fw.file_size / 1024).toFixed(2)} KB</span>\n                          <span>Checksum: {fw.checksum}</span>\n                        </div>\n                      </div>\n                    </div>\n                    <Button\n                      onClick={() => handleDelete(fw.id)}\n                      variant=\"destructive\"\n                      size=\"sm\"\n                      className=\"bg-red-600 hover:bg-red-700\"\n                      data-testid={`delete-firmware-${fw.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport default FirmwareManagement;"}, {"path": "/app/frontend/src/pages/FlashHistory.js", "content": "import { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { toast } from 'sonner';\nimport { ArrowLeft, History, CheckCircle, XCircle, Clock, AlertCircle } from 'lucide-react';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL;\nconst API = `${BACKEND_URL}/api`;\n\nconst FlashHistory = () => {\n  const navigate = useNavigate();\n  const [sessions, setSessions] = useState([]);\n  const [vehicles, setVehicles] = useState({});\n  const [firmware, setFirmware] = useState({});\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    loadHistory();\n  }, []);\n\n  const loadHistory = async () => {\n    try {\n      const [sessionsRes, vehiclesRes, firmwareRes] = await Promise.all([\n        axios.get(`${API}/flash-sessions`),\n        axios.get(`${API}/vehicles`),\n        axios.get(`${API}/firmware`)\n      ]);\n      \n      setSessions(sessionsRes.data);\n      \n      // Create lookup maps\n      const vehicleMap = {};\n      vehiclesRes.data.forEach(v => vehicleMap[v.id] = v);\n      setVehicles(vehicleMap);\n      \n      const firmwareMap = {};\n      firmwareRes.data.forEach(f => firmwareMap[f.id] = f);\n      setFirmware(firmwareMap);\n    } catch (error) {\n      console.error('Error loading history:', error);\n      toast.error('Failed to load flash history');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getStatusIcon = (status) => {\n    switch (status) {\n      case 'completed':\n        return <CheckCircle className=\"w-5 h-5 text-green-400\" />;\n      case 'failed':\n        return <XCircle className=\"w-5 h-5 text-red-400\" />;\n      case 'in_progress':\n        return <Clock className=\"w-5 h-5 text-blue-400 animate-spin\" />;\n      case 'cancelled':\n        return <AlertCircle className=\"w-5 h-5 text-amber-400\" />;\n      default:\n        return <Clock className=\"w-5 h-5 text-gray-400\" />;\n    }\n  };\n\n  const getStatusBadge = (status) => {\n    const classes = {\n      completed: 'badge-success',\n      failed: 'badge-error',\n      in_progress: 'badge-info',\n      cancelled: 'badge-warning',\n      pending: 'badge-warning'\n    };\n    return <span className={`badge ${classes[status]}`} data-testid={`status-${status}`}>{status.replace('_', ' ')}</span>;\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <p className=\"text-lg\">Loading...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen p-6\">\n      <div className=\"max-w-6xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <Button\n            onClick={() => navigate('/')}\n            variant=\"outline\"\n            className=\"mb-4 bg-slate-800 border-slate-700 hover:bg-slate-700\"\n            data-testid=\"back-to-dashboard-btn\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Dashboard\n          </Button>\n          <h1 className=\"text-4xl font-bold text-white mb-2\" data-testid=\"history-title\">Flash History</h1>\n          <p className=\"text-gray-400\">View all ECM programming sessions</p>\n        </div>\n\n        {/* History List */}\n        <Card className=\"glass-card border-slate-700\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center text-white\">\n              <History className=\"w-5 h-5 mr-2 text-purple-400\" />\n              Programming Sessions\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {sessions.length === 0 ? (\n              <p className=\"text-gray-400 text-center py-8\">No flash sessions yet</p>\n            ) : (\n              <div className=\"space-y-4\">\n                {sessions.map((session) => {\n                  const vehicle = vehicles[session.vehicle_id];\n                  const fw = firmware[session.firmware_id];\n                  \n                  return (\n                    <div\n                      key={session.id}\n                      className=\"p-4 bg-slate-800/50 rounded-lg border border-slate-700\"\n                      data-testid={`session-item-${session.id}`}\n                    >\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div className=\"flex items-start gap-3\">\n                          {getStatusIcon(session.status)}\n                          <div>\n                            <h3 className=\"text-white font-semibold\">\n                              {vehicle ? `${vehicle.year} ${vehicle.model}` : 'Unknown Vehicle'}\n                            </h3>\n                            <p className=\"text-sm text-gray-400\">\n                              {vehicle?.vin || 'No VIN'}\n                            </p>\n                          </div>\n                        </div>\n                        {getStatusBadge(session.status)}\n                      </div>\n                      \n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                        <div>\n                          <p className=\"text-gray-400\">Firmware</p>\n                          <p className=\"text-white font-medium\">\n                            {fw?.name || 'Unknown'} v{fw?.version || 'N/A'}\n                          </p>\n                        </div>\n                        <div>\n                          <p className=\"text-gray-400\">Started</p>\n                          <p className=\"text-white font-medium\">\n                            {new Date(session.started_at).toLocaleString()}\n                          </p>\n                        </div>\n                        {session.completed_at && (\n                          <div>\n                            <p className=\"text-gray-400\">Completed</p>\n                            <p className=\"text-white font-medium\">\n                              {new Date(session.completed_at).toLocaleString()}\n                            </p>\n                          </div>\n                        )}\n                        <div>\n                          <p className=\"text-gray-400\">Progress</p>\n                          <p className=\"text-white font-medium\">{session.progress}%</p>\n                        </div>\n                      </div>\n                      \n                      {session.error_message && (\n                        <div className=\"mt-3 p-3 bg-red-500/10 border border-red-500/20 rounded-lg\">\n                          <p className=\"text-red-400 text-sm\">\n                            <strong>Error:</strong> {session.error_message}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n};\n\nexport default FlashHistory;"}]}, "type": "mcp_tool"}
Observation: Successfully wrote 9 files:
- /app/backend/server.py
- /app/backend/bridge_service.py
- /app/frontend/src/App.js
- /app/frontend/src/App.css
- /app/frontend/src/pages/Dashboard.js
- /app/frontend/src/pages/VehicleDetail.js
- /app/frontend/src/pages/FlashWizard.js
- /app/frontend/src/pages/FirmwareManagement.js
- /app/frontend/src/pages/FlashHistory.js
